{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reporte de Incidentes</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/static/JS/navbar.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{
      background: #f2f3f5;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      padding-top: 5rem;
      color: #1f2937;
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    .alert-error {
      background-color: rgba(255, 0, 0, 0.15);
      color: #1e2835;
      border: 1px solid rgba(255, 0, 0, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }

    .alert-success {
      background-color: rgba(0, 128, 0, 0.15);
      color: #1e2835;
      border: 1px solid rgba(0, 128, 0, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }

    .btn {
      padding: .6rem 1rem;
      border-radius: .5rem;
      font-weight: 600;
      transition: .2s;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #099268;
    }
  </style>
</head>

<body>
  {% include "includes/navbar.html" %}

  <div class="max-w-6xl mx-auto px-4 py-8">

    <!-- FORMULARIO: CREAR REPORTE -->
    <div class="card p-8 mb-8">
      <h2 class="text-3xl font-bold mb-6 text-center">Registrar incidente</h2>

      {% if messages %}
      {% for message in messages %}
        {% if "crear" in message.tags %}
          <div class="{{ message.tags }}">{{ message }}</div>
        {% endif %}
      {% endfor %}
      {% endif %}

      <form method="POST" enctype="multipart/form-data" class="space-y-4">
        {% csrf_token %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Fecha del evento -->
          <div>
            <label class="block text-sm mb-1 text-gray-700">Fecha del evento</label>
            <input id="fecha_evento" name="fecha_evento" type="date"
                   class="border border-gray-300 rounded-md p-2 w-full" required />
          </div>

          <!-- Categor√≠a -->
          <div>
            <label class="block text-sm mb-1 text-gray-700">Categor√≠a del incidente</label>
            <select id="categoria" name="categoria"
                    class="border border-gray-300 rounded-md p-2 w-full" required>
              <option value="">Seleccionar categor√≠a</option>
              <option value="accidente-trabajo">üîß Accidente de trabajo</option>
              <option value="fallo-equipamiento">‚öôÔ∏è Fallo de equipamiento</option>
              <option value="incidente-seguridad">üõ°Ô∏è Incidente de seguridad</option>
              <option value="problema-ambiental">üåø Problema ambiental</option>
              <option value="otros-eventos">üìã Otros eventos</option>
            </select>
          </div>
        </div>

        <!-- Descripci√≥n -->
        <div>
          <label class="block text-sm mb-1 text-gray-700">Descripci√≥n detallada</label>
          <textarea id="descripcion" name="descripcion" rows="5"
                    class="border border-gray-300 rounded-md p-3 w-full"
                    required></textarea>
        </div>

        <!-- Foto √∫nica -->
        <div class="mb-2">
          <label class="block text-sm mb-1 text-gray-700">Foto del incidente (una sola imagen)</label>
          <input id="foto" name="foto" type="file" accept="image/*"
                 class="block w-full text-sm file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0 file:text-sm
                        file:bg-blue-600 file:text-white hover:file:bg-blue-700
                        bg-white border border-gray-300 rounded-md"/>
          <p class="text-xs text-gray-500 mt-1">Formatos: JPG/PNG. Tama√±o recomendado &lt; 5MB.</p>
          <img id="preview" alt="" class="mt-3 max-h-48 rounded hidden border border-gray-300">
        </div>

        <button type="submit" class="btn btn-primary bg-green-500 hover:bg-green-600">
          Registrar incidente
        </button>
      </form>
    </div>

    <!-- LISTA (SOLO LECTURA) -->
    <div class="card p-8">
      <h2 class="text-2xl font-bold mb-4 text-center">Mis reportes de incidentes</h2>

      <div class="overflow-x-auto">
        <table class="w-full border border-gray-300 rounded-lg text-sm">
          <thead class="bg-gray-500 text-white border-b border-gray-300">
            <tr class="uppercase">
              <th class="p-2 text-left">Fecha</th>
              <th class="p-2 text-left">Categor√≠a</th>
              <th class="p-2 text-left">Descripci√≥n</th>
              <th class="p-2 text-left">Foto</th>
            </tr>
          </thead>
          <tbody>
            {% for rep in page_obj %}
            <tr class="border-b border-gray-200">
              <td class="p-2 whitespace-nowrap">
                {{ rep.fecha_evento|date:"d-m-Y" }}
              </td>

              <td class="p-2 whitespace-nowrap">{{ rep.categoria|default:"-" }}</td>

              <td class="p-2">
                {{ rep.descripcion|default:"-"|truncatechars:120 }}
              </td>

              <td class="p-2">
                {% if rep.foto %}
                  <a href="{% url 'verFotoIncidente' rep.id_reporte %}"
                     target="_blank"
                     class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="h-6 w-6">
                      <path d="M4 5a2 2 0 0 0-2 2v10c0 ..."/>
                    </svg>
                    <span class="underline">Ver</span>
                  </a>
                {% else %}
                  <span class="text-gray-500">Sin foto</span>
                {% endif %}
              </td>
            </tr>

            {% empty %}
            <tr>
              <td colspan="4" class="p-4 text-center text-gray-500">
                A√∫n no has registrado incidentes.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- PAGINACI√ìN -->
      {% if page_obj.has_other_pages %}
      <div class="flex justify-center mt-6">
        <div class="inline-flex space-x-1">

          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">¬´</a>
          {% else %}
            <span class="px-3 py-2 bg-gray-100 text-gray-400 rounded">¬´</span>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <span class="px-3 py-2 bg-blue-600 text-white rounded">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">¬ª</a>
          {% else %}
            <span class="px-3 py-2 bg-gray-100 text-gray-400 rounded">¬ª</span>
          {% endif %}

        </div>
      </div>
      {% endif %}
    </div>

  </div>

  <script>
    /* PREVIEW */
    const input = document.getElementById('foto');
    const preview = document.getElementById('preview');
    input?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) { preview.classList.add('hidden'); return; }
      if (!file.type.startsWith('image/')) { alert('Selecciona una imagen.'); input.value=''; return; }
      preview.src = URL.createObjectURL(file);
      preview.classList.remove('hidden');
    });

    /* FECHA HOY */
    const f = document.getElementById('fecha_evento');
    if (f && !f.value) f.value = new Date().toISOString().split('T')[0];
  </script>
</body>
</html>

