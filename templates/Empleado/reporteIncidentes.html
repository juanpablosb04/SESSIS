{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reporte de Incidentes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/static/JS/navbar.js"></script>
  <style>
    body{
      background-image:url('/static/Img/fondo.jpg');
      background-size:cover;background-position:center;background-repeat:no-repeat;
      background-attachment:fixed;min-height:100vh;
      padding-top:4rem;font-family:'Inter',sans-serif;background-color:#1a1a1a;
    }
    .alert-error{background:rgba(255,0,0,.15);color:#ff4d4d;border:1px solid rgba(255,0,0,.3);
      border-radius:10px;padding:12px;margin-bottom:10px;text-align:center;font-size:14px;font-weight:500;backdrop-filter:blur(10px)}
    .alert-success{background:rgba(0,128,0,.15);color:#4dff4d;border:1px solid rgba(0,128,0,.3);
      border-radius:10px;padding:12px;margin-bottom:10px;text-align:center;font-size:14px;font-weight:500;backdrop-filter:blur(10px)}
  </style>
</head>
<body class="text-gray-200">

  {% include "includes/navbar.html" %}

  <div class="flex flex-col items-center justify-start py-8">

    <!-- FORMULARIO: CREAR REPORTE -->
    <div class="w-full max-w-[850px] bg-gray-800 rounded-lg shadow-md p-7 mb-10">
      <h2 class="text-2xl font-bold text-gray-200 mb-4">Registrar incidente</h2>

      {% if messages %}
        {% for message in messages %}
          {% if 'crear' in message.tags %}
            {% if 'success' in message.tags %}
              <div class="alert-success">{{ message }}</div>
            {% else %}
              <div class="alert-error">{{ message }}</div>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}

      <form method="POST" enctype="multipart/form-data" class="flex flex-col">
        {% csrf_token %}

        <div class="flex space-x-4 mb-4">
          <!-- Fecha del evento -->
          <div class="w-1/2">
            <label for="fecha_evento" class="block text-sm mb-1">Fecha del evento</label>
            <input id="fecha_evento" name="fecha_evento" type="date"
                   class="bg-gray-700 text-gray-200 border-0 rounded-md p-2 w-full" required />
          </div>

          <!-- Categor√≠a -->
          <div class="w-1/2">
            <label for="categoria" class="block text-sm mb-1">Categor√≠a del incidente</label>
            <select id="categoria" name="categoria"
                    class="bg-gray-700 text-gray-200 border-0 rounded-md p-2 w-full" required>
              <option value="">Seleccionar categor√≠a</option>
              <option value="accidente-trabajo">üîß Accidente de trabajo</option>
              <option value="fallo-equipamiento">‚öôÔ∏è Fallo de equipamiento</option>
              <option value="incidente-seguridad">üõ°Ô∏è Incidente de seguridad</option>
              <option value="problema-ambiental">üåø Problema ambiental</option>
              <option value="otros-eventos">üìã Otros eventos</option>
            </select>
          </div>
        </div>

        <!-- Descripci√≥n -->
        <label for="descripcion" class="block text-sm mb-1">Descripci√≥n detallada</label>
        <textarea id="descripcion" name="descripcion" rows="5"
                  class="bg-gray-700 text-gray-200 border-0 rounded-md p-3 mb-4"
                  placeholder="Circunstancias, personas involucradas, ubicaci√≥n exacta, consecuencias y acciones tomadas‚Ä¶" required></textarea>

        <!-- Foto √∫nica -->
        <div class="mb-2">
          <label for="foto" class="block text-sm mb-1">Foto del incidente (una sola imagen)</label>
          <input id="foto" name="foto" type="file" accept="image/*"
                 class="block w-full text-sm file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0 file:text-sm
                        file:bg-blue-600 file:text-white hover:file:bg-blue-700
                        bg-gray-800 rounded-md"/>
          <p class="text-xs text-gray-400 mt-1">Formatos: JPG/PNG. Tama√±o recomendado &lt; 5MB.</p>
          <img id="preview" alt="" class="mt-3 max-h-48 rounded hidden border border-gray-600">
        </div>

        <button type="submit"
                class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white font-bold py-2 px-4 rounded-md mt-4">
          Registrar incidente
        </button>
      </form>
    </div>

    <!-- LISTA (SOLO LECTURA) -->
    <div class="w-full max-w-[1150px] bg-gray-800/95 rounded-lg shadow-md p-7">
      <h2 class="text-2xl font-bold text-gray-200 mb-4">Mis reportes de incidentes</h2>

      <div class="overflow-x-auto">
        <table class="min-w-full text-left border border-gray-600">
          <thead class="bg-gray-700 text-gray-200">
            <tr>
              <th class="p-2 whitespace-nowrap">Fecha</th>
              <th class="p-2 whitespace-nowrap">Categor√≠a</th>
              <th class="p-2">Descripci√≥n</th>
              <th class="p-2 whitespace-nowrap">Foto</th>
            </tr>
          </thead>
          <tbody class="text-gray-300">
            {% for rep in reportes %}
            <tr class="border-b border-gray-700 hover:bg-gray-700/40 transition">
              <td class="p-2 whitespace-nowrap">
                {% if rep.fecha_evento %}{{ rep.fecha_evento|date:"d-m-Y" }}{% else %}-{% endif %}
              </td>
              <td class="p-2 whitespace-nowrap">{{ rep.categoria|default:"-" }}</td>
              <td class="p-2">
                {{ rep.descripcion|default:"-"|truncatechars:120 }}
              </td>
              <td class="p-2">
                {% if rep.foto and rep.id_reporte %}
                  <a href="{% url 'verFotoIncidente' rep.id_reporte %}"
                     target="_blank"
                     class="inline-flex items-center gap-2 text-blue-300 hover:text-blue-400"
                     title="Ver imagen" rel="noopener noreferrer">
                    <!-- Icono SVG de imagen (no se muestra la foto en la tabla) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                         fill="currentColor" class="h-6 w-6">
                      <path d="M4 5a2 2 0 0 0-2 2v10c0 1.1.9 2 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H4zm0 2h16v7.586l-3.293-3.293a1 1 0 0 0-1.414 0L12 15.586l-2.293-2.293a1 1 0 0 0-1.414 0L4 17V7zm3 2a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
                    </svg>
                    <span class="underline">Ver</span>
                  </a>
                {% else %}
                  <span class="text-gray-400">Sin foto</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="p-4 text-center text-gray-400">A√∫n no has registrado incidentes.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // Previsualizaci√≥n de la imagen seleccionada (una sola foto)
    const input = document.getElementById('foto');
    const preview = document.getElementById('preview');
    input?.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) { preview.classList.add('hidden'); preview.src = ''; return; }
      if (!file.type.startsWith('image/')) { alert('Selecciona una imagen.'); input.value=''; return; }
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.classList.remove('hidden');
    });

    // Fecha hoy por defecto
    const f = document.getElementById('fecha_evento');
    if (f && !f.value) f.value = new Date().toISOString().split('T')[0];
  </script>
</body>
</html>
